# Docker Compose for assetforce-console development
# Usage:
#   Development (combined):   docker-compose up dev
#   Development (separate):   docker-compose up customer-portal-dev admin-console-dev
#   Production:               docker-compose --profile prod up customer-portal admin-console

services:
  # ==========================================================================
  # Development Mode - Hot reload with volume mounts (combined)
  # ==========================================================================
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
      args:
        GITHUB_PACKAGES_TOKEN: ${GITHUB_PACKAGES_TOKEN}
    container_name: assetforce-console-dev
    ports:
      - "3000:3000"  # customer-portal
      - "3001:3001"  # admin-console
    volumes:
      # Mount source code for hot-reload
      - .:/app
      # Preserve node_modules from container (not from host)
      - /app/node_modules
      - /app/apps/customer-portal/node_modules
      - /app/apps/admin-console/node_modules
      - /app/apps/customer-portal/.next
      - /app/apps/admin-console/.next
    environment:
      - NODE_ENV=development
      - GITHUB_PACKAGES_TOKEN=${GITHUB_PACKAGES_TOKEN}
      # Override for Docker: use host.docker.internal to access host services
      - AAC_GRAPHQL_URL=http://host.docker.internal:8081/graphql
      - IMC_GRAPHQL_URL=http://host.docker.internal:8082/graphql
      # Auth configuration
      - AUTH_ENDPOINT=http://host.docker.internal:8081/graphql
      - AUTH_SECRET=this-is-a-dev-secret-min-32-chars!
    networks:
      - assetforce-network

  # ==========================================================================
  # Development Mode - Customer Portal (separate container)
  # ==========================================================================
  customer-portal-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: customer-portal-dev
      args:
        GITHUB_PACKAGES_TOKEN: ${GITHUB_PACKAGES_TOKEN}
    container_name: assetforce-customer-portal-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/customer-portal/.next
    environment:
      - NODE_ENV=development
      - GITHUB_PACKAGES_TOKEN=${GITHUB_PACKAGES_TOKEN}
      - AAC_GRAPHQL_URL=http://host.docker.internal:8081/graphql
      - IMC_GRAPHQL_URL=http://host.docker.internal:8082/graphql
      - AUTH_ENDPOINT=http://host.docker.internal:8081/graphql
      - AUTH_SECRET=this-is-a-dev-secret-min-32-chars!
    networks:
      - assetforce-network

  # ==========================================================================
  # Development Mode - Admin Console (separate container)
  # ==========================================================================
  admin-console-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: admin-console-dev
      args:
        GITHUB_PACKAGES_TOKEN: ${GITHUB_PACKAGES_TOKEN}
    container_name: assetforce-admin-console-dev
    ports:
      - "3001:3001"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/admin-console/.next
    environment:
      - NODE_ENV=development
      - GITHUB_PACKAGES_TOKEN=${GITHUB_PACKAGES_TOKEN}
      - AAC_GRAPHQL_URL=http://host.docker.internal:8081/graphql
      - IMC_GRAPHQL_URL=http://host.docker.internal:8082/graphql
    networks:
      - assetforce-network

  # ==========================================================================
  # Production Mode - Customer Portal
  # ==========================================================================
  customer-portal:
    build:
      context: .
      dockerfile: Dockerfile
      target: customer-portal
      args:
        GITHUB_PACKAGES_TOKEN: ${GITHUB_PACKAGES_TOKEN}
    container_name: assetforce-customer-portal
    profiles:
      - prod
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - AAC_GRAPHQL_URL=http://aac:8081/graphql
      - IMC_GRAPHQL_URL=http://imc:8082/graphql
    networks:
      - assetforce-network
    depends_on:
      - aac
      - imc

  # ==========================================================================
  # Production Mode - Admin Console
  # ==========================================================================
  admin-console:
    build:
      context: .
      dockerfile: Dockerfile
      target: admin-console
      args:
        GITHUB_PACKAGES_TOKEN: ${GITHUB_PACKAGES_TOKEN}
    container_name: assetforce-admin-console
    profiles:
      - prod
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - AAC_GRAPHQL_URL=http://aac:8081/graphql
      - IMC_GRAPHQL_URL=http://imc:8082/graphql
    networks:
      - assetforce-network
    depends_on:
      - aac
      - imc

  # ==========================================================================
  # Backend Services (for standalone testing)
  # Note: For full stack, use assetforce-infra/docker/docker-compose.yml
  # ==========================================================================
  aac:
    image: assetforce/aac:latest
    profiles:
      - prod
    ports:
      - "8081:8081"
    networks:
      - assetforce-network

  imc:
    image: assetforce/imc:latest
    profiles:
      - prod
    ports:
      - "8082:8082"
    networks:
      - assetforce-network

networks:
  assetforce-network:
    driver: bridge
